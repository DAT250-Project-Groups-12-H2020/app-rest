<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FeedApp Vote</title>
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,600,700" rel="stylesheet">
    <link rel="stylesheet" href="../style.css" />
</head>
<body>
    <div id="login_div"> <!-- class="guest-div" -->
        <!-- <h1>Vote</h1> -->
        <h2 id="poll_question">Poll Title here</h2>

        <form id="ans" action="/action_page.php">
            <input type="radio" id="radio_first" name="answer" checked="true">
            <label id="first_answer">Option 1</label>
            <br>
            <input type="radio" id="radio_second" name="answer">
            <label id="second_answer">Option 1</label>
        </form>

        <button onclick="sendVote(localStorage.getItem('id'))">Send Vote</button>
    </div>

    <div class="footer">
        <p style="margin: 0; display: inline;">Time remaining: </p>
        <p id="time_remaining" style="color:black;margin: 0; display: inline;" align="right">3 min</p>
    </div>

    <script>
        var url = "http://localhost:8090/";
        let vote = "first";

        let question = document.getElementById('poll_question');
        let time_remaining = document.getElementById('time_remaining');

        // id of poll the user is voting on
        let id = localStorage.getItem('id');
        getPollAndShowIt(id);


        function getPollAndShowIt(id) {
            var requestOptions = {
                method: 'GET',
                redirect: 'follow',
                credentials: 'include'
            };

            fetch(url + "api/v1/polls?id=" + id, requestOptions)
                .then(response => response.text())
                .then(result => {
                    let poll = JSON.parse(result);
                    console.log(poll);

                    question.innerText = poll.question;

                    document.getElementById('first_answer').innerText = poll.firstAnswer;
                    document.getElementById('second_answer').innerText = poll.secondAnswer;

                    if(poll.startDateTime == null && poll.endDateTime == null){
                        time_remaining.innerText = "Always open";
                        time_remaining.style.color = 'green';
                    }else{
                        // Todo: show time remaining, not just end date
                        if(poll.endDateTime == null){
                            time_remaining.innerText = "Unlimited";
                        }else{
                            time_remaining.innerText = poll.endDateTime;
                        }
                    }

                    // Radio buttons
                    let first_radio = document.getElementById('radio_first');
                    let second_radio = document.getElementById('radio_second');

                    first_radio.addEventListener('click', () => {
                        vote = "first";
                    });
                    second_radio.addEventListener('click', () => {
                        vote = "second";
                    });
                })
                .catch(error => console.log('error', error));
        }

        function findIndexOfNewestId(pollVotes){
            let indexOfNewestId = 0;
            let newestId = 0;

            for(let i = 0; i < pollVotes.length; i++){
                if(pollVotes[i].id > newestId){
                    indexOfNewestId = i;
                    newestId = pollVotes[i].id;
                }
            }
            return indexOfNewestId;
        }

        function sendVote(id) {
            let firstVotes = 0;
            let secondVotes = 0;

            // Get votes from poll
            var requestOptions = {
                method: 'GET',
                redirect: 'follow',
                credentials: 'include'
            };

            fetch(url + "api/v1/polls?id=" + id, requestOptions)
                .then(response => response.text())
                .then(result => {
                    let poll = JSON.parse(result);
                    let pollVotes = poll.votes;

                    let indexOfNewestId = findIndexOfNewestId(pollVotes);

                    if (pollVotes.length != 0) {
                        // Poll has been voted on before
                        firstVotes = pollVotes[indexOfNewestId].firstVotes;
                        secondVotes = pollVotes[indexOfNewestId].secondVotes;
                    }
                    sendPollUpdate(firstVotes, secondVotes);
                })
                .catch(error => console.log('error', error));
        }


        function sendPollUpdate(firstVotes, secondVotes){
            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            console.log("Before:");
            console.log(firstVotes);
            console.log(secondVotes);

            if(vote == "first"){
                firstVotes = firstVotes + 1;
            }else if(vote == "second"){
                secondVotes = secondVotes + 1;
            }

            console.log("After:");
            console.log(firstVotes);
            console.log(secondVotes);

            var raw = JSON.stringify({"firstVotes":firstVotes,"secondVotes":secondVotes});

            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: raw,
                redirect: 'follow',
                credentials: 'include'
            };

            fetch(url + "api/v1/polls/" + id + "/vote", requestOptions)
                .then(response => response.text())
                .then(result => {
                    console.log(result)
                    location.href = "pollvotedone.html";
                })
                .catch(error => console.log('error', error));
        }

    </script>

    <!--ThecoreFirebaseJSSDKisalwaysrequiredandmustbelistedfirst-->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-analytics.js"></script>

    <script>
        //Yourwebapp'sFirebaseconfiguration
        //ForFirebaseJSSDKv7.20.0andlater,measurementIdisoptional
        var firebaseConfig = {
            apiKey: "AIzaSyBVaiwbASOUfS4GoXaPYS62LgMaxsbSZG0",
            authDomain: "dat250-gr-2-h2020-app.firebaseapp.com",
            databaseURL: "https://dat250-gr-2-h2020-app.firebaseio.com",
            projectId: "dat250-gr-2-h2020-app",
            storageBucket: "dat250-gr-2-h2020-app.appspot.com",
            messagingSenderId: "851900401969",
            appId: "1:851900401969:web:32372ee6e94b18bbb4c810",
            measurementId: "G-03WHQEL0R0"
        };
        //InitializeFirebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
    </script>
    <script src="pollvote.js"></script>

</body>
</html>