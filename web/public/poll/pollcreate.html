<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FeedApp Create Poll</title>
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,600,700" rel="stylesheet">
    <link rel="stylesheet" href="../style.css" />
</head>
<body>

    <div>
        <h1>Create Poll</h1>
        <input type="poll code" placeholder="Poll Question" id="poll_question_field"/><br>
        <input type="poll code" placeholder="First Answer" id="first_ans_field"/><br>
        <input type="poll code" placeholder="Second Answer" id="second_ans_field"/><br>

        <form> <!--<form action="/action_page.php">-->
            <label for="start_date">Select Start time and date:</label>
            <input type="date" id="start_date" name="day">
            <input type="time" id="start_time" name="start_time">
        </form>
        <form>
            <label for="end_date">Select End time:</label>
            <input type="date" id="end_date" name="day">
            <input type="time" id="end_time" name="end_time">
        </form>

        <input type="checkbox" id="private" name="private" value="false">
        <label for="private">Private</label><br>

        <button onclick="createPoll()" type="button">Create Poll</button>
    </div>

    <div class="footer">
        <p>Back to <a href="ownpollsoverview.html">poll overview</a>.</p>
    </div>

    <script>
        let url = 'http://localhost:8090';

        async function createPoll() {
            let pollQuestion = document.getElementById("poll_question_field");
            let firstAnswer = document.getElementById("first_ans_field");
            let secondAnswer = document.getElementById("second_ans_field");
            let private = document.getElementById("private");
            let startDate = document.getElementById("start_date");
            let endDate = document.getElementById("end_date");

            let now = new Date(Date.now());

            let startDateChosen = new Date(startDate.value);
            let endDateChosen = new Date(endDate.value);

            let start_time = document.getElementById('start_time');
            let end_time = document.getElementById('end_time');

            let pollBody = {};

            let isDateChosen = false;
            if(endDate.value === "" || startDate.value === "") {
                // Date is not chosen
                pollBody = {
                    "question": pollQuestion.value,
                    "firstAnswer": firstAnswer.value,
                    "secondAnswer": secondAnswer.value,
                    "private": private.checked,
                    "startDateTime":now.toISOString()
                }
            }else{
                // Date is chosen
                isDateChosen = true;

                //Todo: Make a poll with date picked today at current time be an open poll

                let startTimeArr = start_time.value.toString().split(':');
                let startHour = startTimeArr[0];
                let startMinutes = startTimeArr[1];

                let endTimeArr = end_time.value.toString().split(':');
                let endHour = endTimeArr[0];
                let endMinutes = endTimeArr[1];

                startDateChosen.setHours(parseInt(startHour));
                startDateChosen.setMinutes(parseInt(startMinutes));

                endDateChosen.setHours(parseInt(endHour));
                endDateChosen.setMinutes(parseInt(endMinutes));

                let isValidTimeInput = validateTimeInput(startDateChosen, endDateChosen);

                if(!isValidTimeInput){
                    alert("Time input is not valid");
                    console.log("Returning");
                    return;
                }

                    pollBody = {
                        "question":pollQuestion.value,
                        "firstAnswer":firstAnswer.value,
                        "secondAnswer":secondAnswer.value,
                        "startDateTime":startDateChosen,
                        "endDateTime":endDateChosen,
                        "private":private.checked
                }
            }

            if(pollQuestion.value === ""
                || firstAnswer.value === ""
                || secondAnswer.value === ""
            ) {
                alert("Please make sure to choose a question and answers");
            }else if(isDateChosen && (start_time.value === "" || end_time.value === "")){
                alert("Please choose time intervals");
            }else{
                pollPOST();
            }

            function pollPOST(){
                console.log(JSON.stringify(pollBody));
                var requestOptions = {
                    method: 'POST',
                    redirect: 'follow',
                    credentials: 'include',
                    body: JSON.stringify(pollBody),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                fetch(url + '/api/v1/polls/create/', requestOptions)
                    .then(response => response.text())
                    .then(result => {
                        console.log(result)
                        location.href = "ownpollsoverview.html";
                    })
                    .catch(error => console.log('error', error));
            }
        }


        function validateTimeInput(startDateChosen, endDateChosen){
            let startHour = startDateChosen.getHours();
            let startMinutes = startDateChosen.getMinutes();

            let endHour = endDateChosen.getHours();
            let endMinutes = endDateChosen.getMinutes();

            if(startDateChosen == endDateChosen){
                if(startHour > endHour){
                    console.log("No, since " + startHour + " is greater than " + endHour);
                    return false;
                }else if(endHour == startHour && startMinutes > endMinutes){
                    console.log("No, since " + startMinutes + " is greater than " + endMinutes);
                    return false;
                }
            }
            if(endDateChosen < startDateChosen){
                console.log("No, since start date can't be after end date")
                return false;
            }
            return true;
        }
    </script>


    <!--The core Firebase JS SDK is always required and must be listed first-->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-analytics.js"></script>

    <script>
        // Your webapp's Firebase configuration
        //For Firebase JS SDK v7.20.0 and later, measurement Id is optional
        var firebaseConfig = {
            apiKey: "AIzaSyBVaiwbASOUfS4GoXaPYS62LgMaxsbSZG0",
            authDomain: "dat250-gr-2-h2020-app.firebaseapp.com",
            databaseURL: "https://dat250-gr-2-h2020-app.firebaseio.com",
            projectId: "dat250-gr-2-h2020-app",
            storageBucket: "dat250-gr-2-h2020-app.appspot.com",
            messagingSenderId: "851900401969",
            appId: "1:851900401969:web:32372ee6e94b18bbb4c810",
            measurementId: "G-03WHQEL0R0"
        };
        //Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
    </script>
    <script src="pollvote.js"></script>

</body>
</html>